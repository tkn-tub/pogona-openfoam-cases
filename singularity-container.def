Bootstrap: docker
From: openfoamplus/of_v1912_centos73

%setup
    # CLONED_DIR="$(mktemp -d)"
    # git clone --depth 1 https://git.cs.upb.de/mamoko/mamoko-openfoam-cases.git "${CLONED_DIR}"
    # mv "${CLONED_DIR}" "${SINGULARITY_ROOTFS}/mamoko-openfoam-cases"
    # chmod -R 777 "${SINGULARITY_ROOTFS}/mamoko-openfoam-cases"

%files
    # TODO: best practices: "Files should always be owned by a system account (UID less than 500)

%environment
    # source /opt/OpenFOAM/setImage_v1906.sh
    PYENV_ROOT=/opt/pyenv
    PATH=$PYENV_ROOT/shims:$PYENV_ROOT/bin:$PATH

%post
    # We'll use Pyenv as Python releases in CentOS appear to lag behind.
    # Using this tutorial: https://www.tecmint.com/pyenv-install-and-manage-multiple-python-versions-in-linux/
    # Using this Github Gist: https://gist.github.com/jprjr/7667947
    # Also see "Suggested build environment" here: https://github.com/pyenv/pyenv/wiki

    yum install -y epel-release && \
    yum install -y \
        git \
        gcc \
        zlib-devel \
        bzip2-devel \
        readline-devel \
        sqlite-devel \
        openssl-devel \
        tk-devel \
        xz-devel \
        libffi-devel \
        vim \
        fish && \
    git clone https://github.com/pyenv/pyenv.git /opt/pyenv
    
    export PYENV_ROOT=/opt/pyenv
    export PATH=$PYENV_ROOT/shims:$PYENV_ROOT/bin:$PATH
    # Cflags for python compilation with pyenv (see their wiki):
    export CFLAGS="-O2"

    pyenv install 3.8.2 && \
        pyenv global 3.8.2
    pyenv rehash
    python3 --version && \
        python3 -m ensurepip && \
        pip3 install pipenv numpy scipy pandas

    echo 'source /opt/OpenFOAM/setImage_v1912.sh' >> $SINGULARITY_ENVIRONMENT

%runscript
    # Executed if container is run as a binary.
    # echo "Arguments received: $*"
    # exec echo "$@"
    if [ $# -ne 0 ]; then
        exec "$@"
    else
        exec bash --norc
    fi

%startscript
    # Executed if started like so:
    #  singularity instance start cases.sif my-cases-instance
    echo "Startscript"

%test

%labels
    Author ccs-labs.org
    Version v0.0.1

%help
    This container can be used for running OpenFOAM fluid simulations for the Pogona macroscopic molecular communication simulator.
    
    Open a shell for example like so: `./cases.simg /bin/bash`.

    To run a simulation, call this container with "cd /mamoko-openfoam-cases/<case dir> && ./AllRun"
